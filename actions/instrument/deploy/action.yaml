name: 'Deploy OpenTelemetry for GitHub Actions'
description: 'Automatically Deploy OpenTelemetry for GitHub Actions to all workflows'
branding:
  icon: 'activity'
  color: 'blue'
runs:
  using: composite
  steps:
    # cat .github/workflows/observability.yaml | yq '.jobs.export.steps[] | select(.uses == "*/actions/instrument/workflow*") | .env' # TODO use github.workflow, that could be a path
    - name: "Install dependencies"
      shell: bash
      run: type yq || (sudo apt-get update && sudo apt-get install yq)
    - name: "Checkout"
      uses: actions/checkout@v4
      with:
        token: ${{ inputs.github_token }}
    - name: "Find self"
      id: find-self
      shell: bash
      run: |
        if [ -r "${{ github.workflow }}" ]; then
           echo path="${{ github.workflow }}" >> "$GITHUB_OUTPUT
        else
          for workflow_file in "${{ inputs.workflows_directory }}"/*.yaml "${{ inputs.workflows_directory }}"/*.yml; do
            [ "$(cat "$workflow_file" | yq .name)" = "${{ github.workflow }}" ] && echo path="$workflow_file" >> "$GITHUB_OUTPUT && break || true
          done
        fi
    - name: "Find workflow-level observability"
      id: find-workflow-level-instrumentation
      shell: bash
      run: |
        for workflow_file in "${{ inputs.workflows_directory }}"/*.yaml "${{ inputs.workflows_directory }}"/*.yml; do
          cat "$workflow_file" | yq .on.workflow_run.workflows | grep -qv '^null$' && cat "$workflow_file" | yq .jobs.*.steps[].uses | grep -q /actions/instrument/workflow && echo path="$workflow_file" >> "$GITHUB_OUTPUT && break || true
        done
    - name: "Deploy workflow-level observability"
      if: steps.find-workflow-level-instrumentation.outputs.path == null
      shell: bash
      run: |
        echo "${{ inputs.workflow_level_instrumentation_template }}" > "${{ steps.find-workflow-level-instrumentation.outputs.path }}"
    - name: "Update workflow-level observability triggers"
      if: steps.find-workflow-level-instrumentation.outputs.path != null
      shell: bash
      run: |
        names_file="$(mktemp)"
        for workflow_file in "${{ inputs.workflows_directory }}"/*.yaml "${{ inputs.workflows_directory }}"/*.yml; do cat "$workflow_file" | yq .name; done \
          | ([ -n "${{ inputs.workflow_level_instrumentation_exclude }}" ] && grep -qvF "$(echo "${{ inputs.workflow_level_instrumentation_exclude }}" | tr ',' '\n' | tr ':' '\n' | tr ';' '\n')" || cat) \
          | grep -vF "$(cat '${{ steps.find-workflow-level-instrumentation.outputs.path }}' | yq .name)" > "$names_file"
        names=()
        while IFS= read -r line; do
          line="${line%$'\r'}"
          names+=("\"$line\"")
        done < "$names_file"
        yq -i ".on.workflow_run.workflows = [${names[*]}]" "${{ steps.find-workflow-level-instrumentation.outputs.path }}" # TODO add env
    - name: "Deploy job-level observability"
      shell: bash
      run: |
        job_level_instrumentation='${{ inputs.job_level_instrumentation_template }}' # TODO add env
        for workflow_file in "${{ inputs.workflows_directory }}"/*.yaml "${{ inputs.workflows_directory }}"/*.yml; do
          [ -n "${{ inputs.job_level_instrumentation_exclude }}" ] && cat "$workflow_file" | yq .name | grep -qF "$(echo "${{ inputs.job_level_instrumentation_exclude }}" | tr ',' '\n' | tr ':' '\n' | tr ';' '\n')" && continue || true
          cat "$workflow_file" | yq '.jobs | keys[]' | while read -r job_name; do
            yq -i ".jobs.$job_name.steps |= ([{ $job_level_instrumentation }] + .)"
          done
        done
    - name: "Open Pull Request"
      id: open-pr
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ inputs.github_token }}
        branch: "deploy-otel"
        commit-message: "Deploy OpenTelemetry"
        title: "Deploy OpenTelemetry"
        body: |
          This PR deploys workflow-level and job-level OpenTelemetry instrumentation to every workflow.
          (this PR is automatically generated)
        delete-branch: true
    - name: "Delay" # to let the api and PR state catch up ...
      if: steps.open-pr.outputs.pull-request-number != null
      shell: bash
      run: sleep 60
    - name: "Enable auto-merge"
      if: steps.open-pr.outputs.pull-request-number != null
      uses: peter-evans/enable-pull-request-automerge@v3
      with:
        token: ${{ inputs.github_token }}
        pull-request-number: ${{ steps.open-pr.outputs.pull-request-number }}
        merge-method: squash
inputs:
  github_token:
    description: 'A GitHub token for API access (read/write)'
    default: '${{ github.token }}'
  workflows_directory:
    default: '.github/workflows'
  workflow_level_instrumentation_file_name:
    default: 'observability.yaml'
  workflow_level_instrumentation_exclude:
    description: 'Comma-separated list of workflow names to exclude from workflow-level instrumentation.'
    default: ''
  job_level_instrumentation_exclude:
    description: 'Comma-separated list of workflow names to exclude from job-level instrumentation.'
    default: ''
  workflow_level_instrumentation_template:
    default: |
      name: OpenTelemetry
      on:
        workflow_run:
          workflows: []
          types:
            - completed
      jobs:
        export:
          runs-on: ubuntu-latest
          steps:
            - uses: plengauer/opentelemetry-github/actions/instrument/workflow@v5.10.1
              env:
  job_level_instrumentation_template:
    default: |
      uses: plengauer/opentelemetry-github/actions/instrument/job@v5.10.1
      with:
        secrets_to_redact: '${{ toJSON(secrets) }}'
      env:
  debug:
    description: 'Enable debug logging'
    default: ${{ runner.debug }}
