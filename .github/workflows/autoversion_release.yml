name: Autoversion Release
on:
  push:
    branches:
      - 'release/v*.*'
    paths:
      - 'meta/**'
      - 'src/**'
      - 'actions/**'
      - '!VERSION'
concurrency:
  group: bump-version-${{ github.ref }}
  cancel-in-progress: false
jobs:
  bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - uses: plengauer/opentelemetry-github/actions/instrument/job@v5.33.5
        env:
          OTEL_EXPORTER_OTLP_ENDPOINT: ${{ secrets.OTEL_EXPORTER_OTLP_ENDPOINT }}
          OTEL_EXPORTER_OTLP_HEADERS: ${{ secrets.OTEL_EXPORTER_OTLP_HEADERS }}
        with:
          secrets_to_redact: '["${{ github.token }}","${{ secrets.ACTIONS_GITHUB_TOKEN }}"]'
      - uses: actions/checkout@v5.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.ACTIONS_GITHUB_TOKEN }}
      
      - id: bump
        run: |
          set -e
          
          echo "::group::Bump patch version"
          current_version=$(cat VERSION)
          major=$(echo "$current_version" | cut -d. -f1)
          minor=$(echo "$current_version" | cut -d. -f2)
          patch=$(echo "$current_version" | cut -d. -f3)
          
          new_patch=$((patch + 1))
          new_version="${major}.${minor}.${new_patch}"
          echo "$new_version" > VERSION
          echo "new_version=$new_version" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"
      
      - id: open-pr
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          token: ${{ secrets.ACTIONS_GITHUB_TOKEN }}
          commit-message: "Bump Version"
          base: ${{ github.ref_name }}
          branch: versionbump/${{ github.ref_name }}
          title: "Automatic Version Bump"
          body: |
            This PR bumps version(s) to trigger a release.
            (this PR is automatically generated)
          delete-branch: true
      - run: sleep 60
      - run: gh pr merge --squash --auto ${{ steps.open-pr.outputs.pull-request-number }}
        env:
          GH_TOKEN: ${{ secrets.ACTIONS_GITHUB_TOKEN }}
