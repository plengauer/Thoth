set +f
if ! type sudo || ! type systemctl || ! type apt-get; then
  exit 0
fi

if [ -n "${GITHUB_TOKEN:-}" ] && type debconf-set-selections; then
  echo gitaptly gitaptly/GITHUB_API_TOKEN string "$GITHUB_TOKEN" | sudo debconf-set-selections
fi
curl --fail --retry 16 --retry-all-errors https://api.github.com/repos/plengauer/abom-http/releases/latest https://api.github.com/repos/plengauer/gitaptly/releases/latest | jq -r '.assets[].browser_download_url' | grep '.deb$' | xargs wget
DEBIAN_FRONTEND=noninteractive sudo -E apt-get install -y ./*.deb || exit 0
sleep 5
find /var/lib/gitaptly
set -x
\cat /var/lib/gitaptly/dists/stable/main/binary-all/Packages
\curl -v http://127.0.0.1:8000/dists/stable/main/binary-all/Packages 2>&1
curl -v http://127.0.0.1:8000/dists/stable/main/binary-all/Packages | grep '^Filename: ' | cut -d ' ' -f 2- | head -n1 | xargs -I {} wget http://127.0.0.1:8000/{}
