if ! which python3; then exit 0; fi
. ./assert.sh

. /opt/opentelemetry_shell/venv/bin/activate
opentelemetry-instrument python3 -c 'print ("hello world 0")'
deactivate

python3 -m venv ./venv
. ./venv/bin/activate
pip3 install requests
export PYTHONPATH=/opt/opentelemetry_shell/venv/lib/python3.12/site-packages
./venv/bin/python3 /opt/opentelemetry_shell/venv/bin/opentelemetry-instrument python3 -c 'print ("hello world 1")' || exit 1
unset PYTHONPATH
deactivate

. otel.sh

#TODO test subprocesses
#TODO check for parent being external

dir=$(mktemp -d)
python3 -m venv "$dir"/venv
. "$dir"/venv/bin/activate
\pip3 install requests # TODO why does this need to be escaped, its not even deeply injected! also fix other pips
echo '
import requests
requests.get("http://example.com/foo")
' | OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE python3 | tee /dev/stderr | grep -- '/foo' || exit 1
deactivate

dir=$(mktemp -d)
python3 -m venv "$dir"/venv
. "$dir"/venv/bin/activate
\pip install requests
echo '
import requests
requests.get("http://example.com/bar")
' | OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE python | tee /dev/stderr | grep -- '/bar' || exit 1
deactivate

dir=$(mktemp -d)
python3 -m venv "$dir"/venv
. "$dir"/venv/bin/activate
\pip3 install requests
\pip3 install opentelemetry-distro opentelemetry-exporter-otlp
opentelemetry-bootstrap --action install
script=$(mktemp -u).py
echo '
import requests
requests.get("http://example.com/baz")
' > "$script"
OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE opentelemetry-instrument python3 "$script" | tee /dev/stderr | grep -- '/baz' || exit 1
deactivate

exit 1
