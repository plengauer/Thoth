if ! which python3; then exit 0; fi
. ./assert.sh

. otel.sh

#TODO test subprocesses

export OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE

pip3 install requests

echo '
import requests
requests.get("http://example.com/foo")
' | python3 | grep -v -F '"parent_id": null,' | grep -- '/foo' || exit 1

python3 -c '
import requests
requests.get("http://example.com/bar")
' | grep -v -F '"parent_id": null,' | grep -- '/bar' || exit 1

echo '
import requests
requests.get("http://example.com/baz")
' > script.py
python3 script.py | grep -v -F '"parent_id": null,' | grep -- '/baz' || exit 1

exit 0

# TODO right now venvs are not supported

dir=$(mktemp -d)
python3 -m venv --system-site-packages "$dir"/venv
. "$dir"/venv/bin/activate
pip install requests
echo '
import requests
requests.get("http://example.com/bar")
' | OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE python | grep -v -F '"parent_id": null,' | grep -- '/bar' || exit 1
deactivate

dir=$(mktemp -d)
python3 -m venv --system-site-packages "$dir"/venv
. "$dir"/venv/bin/activate
pip3 install requests
pip3 install opentelemetry-distro opentelemetry-exporter-otlp
opentelemetry-bootstrap --action install || exit 1
script=$(mktemp -u).py
echo '
import requests
requests.get("http://example.com/baz")
' > "$script"
OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE opentelemetry-instrument python3 "$script" | grep -v -F '"parent_id": null,' | grep -- '/baz' || exit 1
deactivate
