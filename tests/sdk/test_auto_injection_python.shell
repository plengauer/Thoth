if ! which python3; then exit 0; fi
. ./assert.sh

. otel.sh

#TODO test subprocesses

dir=$(mktemp -d)
pip3 install requests # TODO why does this need to be escaped, its not even deeply injected! also fix other pips
echo '
import requests
requests.get("http://example.com/foo")
' | OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE python3 | grep -v -F '"parent_id": null,' | grep -- '/foo' || exit 1

dir=$(mktemp -d)
python3 -m venv --system-site-packages "$dir"/venv # TODO the -- should not be necessary
. "$dir"/venv/bin/activate
pip install requests
echo '
import requests
requests.get("http://example.com/bar")
' | OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE python | grep -v -F '"parent_id": null,' | grep -- '/bar' || exit 1
deactivate

dir=$(mktemp -d)
python3 -m venv --system-site-packages "$dir"/venv
. "$dir"/venv/bin/activate
pip3 install requests
pip3 install opentelemetry-distro opentelemetry-exporter-otlp
opentelemetry-bootstrap --action install
script=$(mktemp -u).py
echo '
import requests
requests.get("http://example.com/baz")
' > "$script"
OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE opentelemetry-instrument python3 "$script" | grep -v -F '"parent_id": null,' | grep -- '/baz' || exit 1
deactivate

exit 1
