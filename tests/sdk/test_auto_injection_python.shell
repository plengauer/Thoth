if ! which python3; then exit 0; fi
. ./assert.sh

. otel.sh

#TODO test subprocesses

echo '
import requests
requests.get("http://example.com/foo")
' | OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE python3 | grep -v -F '"parent_id": null,' | grep -- '/foo' || exit 1

echo "DEBUG 0"
dir=$(mktemp -d)
echo "DEBUG 1"
python3 -m venv --system-site-packages "$dir"/venv
echo "DEBUG 2"
. "$dir"/venv/bin/activate
echo "DEBUG 3"
pip install requests
echo "DEBUG 4"
type python
alias
echo '
import requests
requests.get("http://example.com/bar")
' | OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE python | grep -v -F '"parent_id": null,' | grep -- '/bar' || exit 1
echo "DEBUG 5"
deactivate
echo "DEBUG 6"

dir=$(mktemp -d)
python3 -m venv --system-site-packages "$dir"/venv
. "$dir"/venv/bin/activate
pip3 install requests
pip3 install opentelemetry-distro opentelemetry-exporter-otlp
opentelemetry-bootstrap --action install || exit 1
script=$(mktemp -u).py
echo '
import requests
requests.get("http://example.com/baz")
' > "$script"
OTEL_SHELL_CONFIG_INJECT_DEEP=TRUE opentelemetry-instrument python3 "$script" | grep -v -F '"parent_id": null,' | grep -- '/baz' || exit 1
deactivate

exit 1
