if ! [ -x "$(which ncat)" ]; then exit 0; fi
set -e
. ./assert.sh

otel4netcat ncat -v -l -p 12345 -c cat &
pid="$?"
sleep 3
assert_equals "hello world" "$(echo -n hello world | netcat -w 1 127.0.0.1 12345)"
wait "$?"

span="$(resolve_span '.name == "cat"')"
assert_equals "SpanKind.INTERNAL" $(\echo "$span" | jq -r '.kind')
span_id=$(\echo "$span" | jq -r '.parent_id')
span="$(resolve_span '.context.span_id == "'$span_id'"')"
assert_equals "SpanKind.CONSUMER" $(\echo "$span" | jq -r '.kind')
assert_equals "send/receive" $(\echo "$span" | jq -r '.name')
span="$(resolve_span '.context.span_id == "'$span_id'"')"
assert_equals "SpanKind.INTERNAL" $(\echo "$span" | jq -r '.kind')
assert_equals "ncat -v -l -p 12345 -c cat" $(\echo "$span" | jq -r '.name')

span="$(resolve_span '.name == "netcat -w 1 127.0.0.1 12345"')"
assert_equals "SpanKind.INTERNAL" $(\echo "$span" | jq -r '.kind')
span_id=$(\echo "$span" | jq -r '.context.span_id')
span="$(resolve_span '.parent_id == "'$span_id'"')"
assert_equals "SpanKind.PRODUCER" $(\echo "$span" | jq -r '.kind')
assert_equals "send/receive" $(\echo "$span" | jq -r '.name')
