if [ "$SHELL" = "zsh" ]; then
  return 0
fi

. /usr/bin/opentelemetry_shell.sh
alias

if [ -n "$(alias | grep ech | grep cho)" ]; then printf '%s' "e-cho has been instrumented"; exit 1; fi
. auto/count_fail_no_auto.shell
alias
if [ -z "$(alias | grep ech | grep cho)" ]; then printf '%s' "e-cho has not been instrumented"; exit 1; fi

if [ "$(alias | wc -l)" -gt "50" ]; then
  printf '%s' "too many instrumentations"
  exit 1
fi

if [ -n "$(alias alias | grep otel_observe)" ] || [ -n "$(alias unalias | grep otel_observe)" ] || [ -n "$(alias . | grep otel_observe)" ]; then
  printf '%s' "aliased or unalias or . has been instrumented"
  exit 1
fi

full_instrumentation="$(\bash -c '. /usr/bin/opentelemetry_shell.sh
alias')"
assert_equals "" "$(printf '%s' "$full_instrumentation" | sed 's/^alias //g' | cut -d= -f1 | grep '^OTEL_')"
assert_equals "" "$(printf '%s' "$full_instrumentation" | sed 's/^alias //g' | cut -d= -f1 | grep '^_otel_')"
assert_equals "" "$(printf '%s' "$full_instrumentation" | sed 's/^alias //g' | cut -d= -f1 | grep '^otel_')"

exit 0
